# @dojo/test-extras

[![Build Status](https://travis-ci.org/dojo/test-extras.svg?branch=master)](https://travis-ci.org/dojo/test-extras)
[![codecov](https://codecov.io/gh/dojo/test-extras/branch/master/graph/badge.svg)](https://codecov.io/gh/dojo/test-extras)
[![npm version](https://badge.fury.io/js/%40dojo%2Ftest-extras.svg)](http://badge.fury.io/js/%40dojo%2Ftest-extras)

A package that contains various modules to make it easier to test Dojo 2 with Intern.

**WARNING** This is *alpha* software. It is not yet production ready, so you should use at your own risk.

## Features

### `assertRender()`

`assertRender()` is an assertion function that throws when there is a discrepency between an actual Dojo virtual DOM (`DNode`)
and the expected Dojo virtual DOM.

Typically, this would be used with the Dojo virtual DOM functions `v()` and `w()` provided in `@dojo/widget-core/d` in the following
way:

```typescript
import { v } from '@dojo/widget-core/d';
import assertRender from '@dojo/test-extras/support/assertRender';

function someRenderFunction () {
  return v('div', { styles: { 'color': 'blue' } }, [ 'Hello World!' ]);
}

assertRender(someRenderFunction(), v('div', {
    styles: {
      'color': 'blue'
    }
  }, [ 'Hello World!' ]), 'renders should match');
```

There are some important things to note about how `assertRender()` compares `DNode`s.

First, on function values of the properties of a `DNode`, their equality is simply compared on the presence of the value and that
both actual and expected values are `typeof` functions.  This is because it challenging to gain the direct reference of a
function, like an event handler.  If there is a mismatch between the presence of the property or the type of the value,
`asserRender()` will throw.

Second, widget constructors (in `WNode`s/generated by `w()`) are compared by strict equality.  They can be strings (if using the widget
registry), but the actual constructor functions will not be resolved.

Third, `DNode`s will not be rendered when comparing.  Simply their children will be walked, but if a `DNode`'s rendering causes
additional virtual DOM to be rendered (e.g. a `w()`/`WNode` which has a widget constructor that renders additional widgets),
the will not be compared.  If those comparisons are important, then walking the `DNode` structure and comparing the results
using `assertRender()` would need to be done.

### `ClientErrorCollector`

`ClientErrorCollector` is a class that will collect errors from a remote session with Intern.  This is typically used with
functional tests, when there might be client error messages which are not effecting the functionality of the test, but are
undesired.

Typical usage would be to create an instance of the `ClientErrorCollector` providing the remote session, `.init()` the collector
which will install the collection script on the remote client, run whatever additional tests are desired, and then call `.finish()`
which will resolve with any errors that were collected or call `.assertNoErrors()`.  `.assertNoErrors()` either resolves if there
were no errors, or rejects with the first error collecte.  For example:

```typescript
import * as assert from 'intern/chai!assert';
import * as registerSuite from 'intern!object';
import * as Suite from 'intern/lib/Suite';
import ClientErrorCollector from '@dojo/test-extras/intern/ClientErrorCollector';

registerSuite({
  name: 'Test',

  'functional testing'(this: Suite) {
    const collector = new ClientErrorCollector(this.remote);
    return this.remote
      .get('SomeTest.html')
      .then(() => collector.init())
      .execute(() => {
        /* some test code */
      })
      .then(() => collector.assertNoErrors());
  }
});
```

## How do I contribute?

We appreciate your interest!  Please see the [Dojo 2 Meta Repository](https://github.com/dojo/meta#readme) for the
Contributing Guidelines and Style Guide.

### Installation

To start working with this package, clone the repository and run `npm install`.

In order to build the project, run `grunt dev` or `grunt dist`.

## Testing

Test cases MUST be written using [Intern](https://theintern.github.io) using the Object test interface and Assert assertion interface.

90% branch coverage MUST be provided for all code submitted to this repository, as reported by istanbul’s combined coverage results for all supported platforms.

To test locally in node run:

`grunt test`

To test against browsers with a local selenium server run:

`grunt test:local`

To test against BrowserStack or Sauce Labs run:

`grunt test:browserstack`

or

`grunt test:saucelabs`

## Licensing information

- `src/support/AssertionError` is adapted from [assertion-error](https://github.com/chaijs/assertion-error)
  and is © 2013 Jake Luer and [MIT Licensed](http://opensource.org/licenses/MIT)

© [JS Foundation](https://js.foundation/) & contributors. [New BSD](http://opensource.org/licenses/BSD-3-Clause) license.
